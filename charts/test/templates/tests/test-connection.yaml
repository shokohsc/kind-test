apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-smoke-test"
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: curl
      image: curlimages/curl
      args: ['-LIX', 'GET', '{{ include "pihole.fullname" . }}:{{ .Values.service.port }}']
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-smoke-test-dns"
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: resolv-conf
      image: busybox
      command: ['cat']
      args: ['/etc/resolv.conf']
    - name: nc
      image: busybox
      command: ['nc']
      args: ['-v', '-z', '-u', '{{ include "pihole.fullname" . }}-dns', '53']
  restartPolicy: Never
---
{{- if .Values.dhcp.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-smoke-test-dhcp"
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: resolv-conf
      image: busybox
      command: ['cat']
      args: ['/etc/resolv.conf']
    - name: nc
      image: busybox
      command: ['nc']
      args: ['-v', '-z', '-u', '{{ include "pihole.fullname" . }}-dhcp', '67']
  restartPolicy: Never
{{- end }}
---
{{- if .Values.doh.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-smoke-test-doh"
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: resolv-conf
      image: busybox
      command: ['cat']
      args: ['/etc/resolv.conf']
    - name: nc
      image: busybox
      command: ['nc']
      args: ['-v', '-z', '-u', '{{ include "pihole.fullname" . }}-doh', '5053']
    - name: nc-metrics
      image: busybox
      command: ['nc']
      args: ['-v', '-z', '{{ include "pihole.fullname" . }}-doh', '49312']
    - name: nslookup
      image: busybox
      command: ['nslookup']
      args: ['-port=5053', 'google.com', '{{ include "pihole.fullname" . }}-doh']
  restartPolicy: Never
{{- end }}

# TEST DHCP https://serverfault.com/questions/171744/command-line-program-to-test-dhcp-service

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: {{ include "pihole.fullname" . }}
  labels: {{- include "pihole.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook-weight": "-30"
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: 1Gi
storageClass: nfs
